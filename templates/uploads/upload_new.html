{% extends 'base.html' %}
{% load static %}

{% block title %}Upload Data - ArthSutra{% endblock %}

{% block content %}
<div class="container-fluid content-wrapper">
    <div class="row">
        <!-- Main Content -->
        <div class="col-12 main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-upload text-primary me-2"></i>Bulk Data Upload</h2>
                <a href="{% url 'upload_history' %}" class="btn btn-outline-info">
                    <i class="fas fa-history me-1"></i>Upload History
                </a>
            </div>

            <!-- Upload Instructions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Upload Instructions</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-file-csv text-success me-2"></i>Supported Formats</h6>
                                    <ul class="mb-3">
                                        <li>CSV files (.csv)</li>
                                        <li>Excel files (.xlsx)</li>
                                        <li>UTF-8 encoding recommended</li>
                                        <li>First row must contain headers</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-list-check text-primary me-2"></i>Upload Order</h6>
                                    <ol class="mb-3">
                                        <li>Upload <strong>Departments</strong> first</li>
                                        <li>Then upload <strong>Expenses</strong></li>
                                        <li>Finally upload <strong>Income</strong></li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Forms -->
            <div class="row">
                <!-- Department Upload -->
                {% if user.role == 'ADMIN' %}
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-building me-2"></i>Department Data</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">Upload department information. This should be done first.</p>
                            <form method="post" enctype="multipart/form-data" action="{% url 'upload' %}" id="departmentForm">
                                {% csrf_token %}
                                <input type="hidden" name="file_type" value="DEPARTMENT">
                                <div class="mb-3">
                                    <label class="form-label">Select File</label>
                                    <input type="file" class="form-control" name="file" accept=".csv,.xlsx" required>
                                    <div class="form-text">Supported: CSV, Excel (.xlsx)</div>
                                </div>
                                <button type="submit" class="btn btn-warning w-100">
                                    <i class="fas fa-upload me-2"></i>Upload Departments
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Expense Upload -->
                {% if user.role == 'ADMIN' or user.role == 'EXPENSE_USER' %}
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0"><i class="fas fa-arrow-down me-2"></i>Expense Data</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">Upload expense records. Departments must exist first.</p>
                            <form method="post" enctype="multipart/form-data" action="{% url 'upload' %}" id="expenseForm">
                                {% csrf_token %}
                                <input type="hidden" name="file_type" value="EXPENSE">
                                <div class="mb-3">
                                    <label class="form-label">Select File</label>
                                    <input type="file" class="form-control" name="file" accept=".csv,.xlsx" required>
                                    <div class="form-text">Supported: CSV, Excel (.xlsx)</div>
                                </div>
                                <button type="submit" class="btn btn-danger w-100">
                                    <i class="fas fa-upload me-2"></i>Upload Expenses
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Income Upload -->
                {% if user.role == 'ADMIN' or user.role == 'INCOME_USER' %}
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-arrow-up me-2"></i>Income Data</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">Upload income/service records. Departments must exist first.</p>
                            <form method="post" enctype="multipart/form-data" action="{% url 'upload' %}" id="incomeForm">
                                {% csrf_token %}
                                <input type="hidden" name="file_type" value="INCOME">
                                <div class="mb-3">
                                    <label class="form-label">Select File</label>
                                    <input type="file" class="form-control" name="file" accept=".csv,.xlsx" required>
                                    <div class="form-text">Supported: CSV, Excel (.xlsx)</div>
                                </div>
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-upload me-2"></i>Upload Income
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- File Format Information -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-file-alt text-primary me-2"></i>File Format Specifications</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6 class="text-warning">Department CSV Format:</h6>
                                    <pre class="bg-light p-2 rounded small"><code>name
Cardiology
Radiology
Pharmacy</code></pre>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-danger">Expense CSV Format:</h6>
                                    <pre class="bg-light p-2 rounded small"><code>department_id,expense_type,amount,date
1,Medical Supplies,50000.00,2024-01-15
1,Equipment,25000.00,2024-01-20</code></pre>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-success">Income CSV Format:</h6>
                                    <pre class="bg-light p-2 rounded small"><code>department_id,service_type,amount,date
1,Consultation,15000.00,2024-01-15
2,Pharmacy Sales,75000.00,2024-01-22</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            {% if messages %}
                <div class="row">
                    <div class="col-12">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-info-circle me-2"></i>{{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% block extra_scripts %}
<script>
    // Form submission handling
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

            // Re-enable after 30 seconds (in case of long processing)
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }, 30000);
        });
    });

    // File validation
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Check file extension instead of MIME type for better compatibility
                const fileName = file.name.toLowerCase();
                const allowedExtensions = ['.csv', '.xlsx', '.xls'];
                const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));

                if (!hasValidExtension) {
                    alert('Please select a valid CSV or Excel file (.csv, .xlsx, .xls).');
                    this.value = '';
                    return;
                }

                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB.');
                    this.value = '';
                    return;
                }
            }
        });
    });
</script>
{% endblock %}
{% endblock %}